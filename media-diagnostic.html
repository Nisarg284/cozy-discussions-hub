<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Camera and Microphone Diagnostic Tool</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        h1, h2 {
            color: #333;
        }
        .container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }
        .panel {
            flex: 1;
            min-width: 300px;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        video {
            width: 100%;
            background-color: #000;
            border-radius: 4px;
        }
        button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px 15px;
            margin: 5px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover {
            background-color: #45a049;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        .error {
            color: #d32f2f;
            background-color: #ffebee;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .success {
            color: #388e3c;
            background-color: #e8f5e9;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .warning {
            color: #f57c00;
            background-color: #fff3e0;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .log {
            height: 200px;
            overflow-y: auto;
            background-color: #f5f5f5;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            margin-top: 10px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        .controls {
            margin: 15px 0;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 5px;
        }
        .status-green {
            background-color: #4CAF50;
        }
        .status-red {
            background-color: #d32f2f;
        }
        .status-yellow {
            background-color: #f57c00;
        }
        .hidden {
            display: none;
        }
        .tab-buttons {
            display: flex;
            margin-bottom: 15px;
        }
        .tab-button {
            background-color: #f2f2f2;
            color: #333;
            border: 1px solid #ddd;
            border-bottom: none;
            padding: 10px 15px;
            cursor: pointer;
            border-radius: 4px 4px 0 0;
        }
        .tab-button.active {
            background-color: #fff;
            border-bottom: 2px solid #4CAF50;
        }
        .tab-content {
            display: none;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 0 4px 4px 4px;
        }
        .tab-content.active {
            display: block;
        }
    </style>
</head>
<body>
    <h1>Camera and Microphone Diagnostic Tool</h1>
    <p>This tool helps diagnose issues with camera and microphone access in your browser.</p>

    <div class="tab-buttons">
        <button class="tab-button active" onclick="openTab(event, 'mediaTest')">Media Test</button>
        <button class="tab-button" onclick="openTab(event, 'systemInfo')">System Info</button>
        <button class="tab-button" onclick="openTab(event, 'troubleshooting')">Troubleshooting</button>
    </div>

    <div id="mediaTest" class="tab-content active">
        <div class="container">
            <div class="panel">
                <h2>Camera & Microphone Test</h2>
                <video id="video" autoplay playsinline muted></video>
                <div class="controls">
                    <button id="startBoth">Start Camera & Mic</button>
                    <button id="startVideo">Video Only</button>
                    <button id="startAudio">Audio Only</button>
                    <button id="stopMedia" disabled>Stop</button>
                </div>
                <div id="mediaStatus"></div>
            </div>

            <div class="panel">
                <h2>Device Information</h2>
                <div id="deviceInfo">Click any start button to see device information</div>
                <h3>Available Devices</h3>
                <div id="deviceList">Loading...</div>
            </div>
        </div>

        <div class="panel">
            <h2>Debug Log</h2>
            <div class="log" id="log"></div>
        </div>
    </div>

    <div id="systemInfo" class="tab-content">
        <div class="panel">
            <h2>Browser Information</h2>
            <table>
                <tr>
                    <th>Property</th>
                    <th>Value</th>
                </tr>
                <tr>
                    <td>User Agent</td>
                    <td id="userAgent"></td>
                </tr>
                <tr>
                    <td>Browser</td>
                    <td id="browserInfo"></td>
                </tr>
                <tr>
                    <td>Platform</td>
                    <td id="platformInfo"></td>
                </tr>
                <tr>
                    <td>WebRTC Support</td>
                    <td id="webrtcSupport"></td>
                </tr>
                <tr>
                    <td>MediaDevices API</td>
                    <td id="mediaDevicesSupport"></td>
                </tr>
                <tr>
                    <td>Screen Sharing</td>
                    <td id="screenSharingSupport"></td>
                </tr>
            </table>
        </div>

        <div class="panel">
            <h2>Connection Test</h2>
            <button id="testStun">Test STUN Server</button>
            <div id="stunResult"></div>
            <div class="log" id="iceLog"></div>
        </div>
    </div>

    <div id="troubleshooting" class="tab-content">
        <div class="panel">
            <h2>Common Issues & Solutions</h2>
            
            <h3>Camera/Microphone Access Denied</h3>
            <p>If you're seeing "NotAllowedError" or "Permission denied" errors:</p>
            <ul>
                <li>Check browser permissions:
                    <ul>
                        <li>Chrome: chrome://settings/content/camera and chrome://settings/content/microphone</li>
                        <li>Edge: edge://settings/content/camera and edge://settings/content/microphone</li>
                        <li>Firefox: about:preferences#privacy (Permissions section)</li>
                    </ul>
                </li>
                <li>Check system permissions:
                    <ul>
                        <li>Windows: Settings > Privacy > Camera/Microphone</li>
                        <li>macOS: System Preferences > Security & Privacy > Privacy > Camera/Microphone</li>
                    </ul>
                </li>
            </ul>

            <h3>Device Not Found</h3>
            <p>If you're seeing "NotFoundError" or "DevicesNotFoundError" errors:</p>
            <ul>
                <li>Make sure your camera/microphone is properly connected</li>
                <li>Check if the device is recognized by your operating system</li>
                <li>Try using an external camera/microphone</li>
                <li>Update device drivers</li>
            </ul>

            <h3>Device In Use</h3>
            <p>If you're seeing "NotReadableError" or "TrackStartError" errors:</p>
            <ul>
                <li>Close other applications that might be using your camera/microphone</li>
                <li>Check if you have multiple browser tabs open using the camera</li>
                <li>Restart your browser</li>
                <li>Restart your computer</li>
            </ul>

            <h3>WebRTC Connection Issues</h3>
            <p>If your camera works in this test but not in your application:</p>
            <ul>
                <li>Check if your signaling server is running (usually on port 3001)</li>
                <li>Ensure your network allows WebRTC connections</li>
                <li>Try disabling any VPN or proxy services</li>
                <li>Check browser console for specific error messages</li>
            </ul>
        </div>
    </div>

    <script>
        // DOM Elements
        const video = document.getElementById('video');
        const startBothBtn = document.getElementById('startBoth');
        const startVideoBtn = document.getElementById('startVideo');
        const startAudioBtn = document.getElementById('startAudio');
        const stopMediaBtn = document.getElementById('stopMedia');
        const mediaStatus = document.getElementById('mediaStatus');
        const deviceInfo = document.getElementById('deviceInfo');
        const deviceList = document.getElementById('deviceList');
        const logElement = document.getElementById('log');
        const testStunBtn = document.getElementById('testStun');
        const stunResult = document.getElementById('stunResult');
        const iceLog = document.getElementById('iceLog');

        // System info elements
        document.getElementById('userAgent').textContent = navigator.userAgent;
        document.getElementById('platformInfo').textContent = navigator.platform;

        // Detect browser
        const browserInfo = (function() {
            const ua = navigator.userAgent;
            let browser = "Unknown";
            let version = "";
            
            if (ua.indexOf("Chrome") > -1) {
                browser = "Chrome";
                version = ua.match(/Chrome\/(\d+)/)[1];
            } else if (ua.indexOf("Firefox") > -1) {
                browser = "Firefox";
                version = ua.match(/Firefox\/(\d+)/)[1];
            } else if (ua.indexOf("Safari") > -1 && ua.indexOf("Chrome") === -1) {
                browser = "Safari";
                version = ua.match(/Version\/(\d+)/)[1];
            } else if (ua.indexOf("Edge") > -1 || ua.indexOf("Edg") > -1) {
                browser = "Edge";
                const match = ua.match(/Edge\/(\d+)/) || ua.match(/Edg\/(\d+)/);
                version = match ? match[1] : "";
            }
            
            return `${browser} ${version}`;
        })();
        document.getElementById('browserInfo').textContent = browserInfo;

        // Check WebRTC support
        const webrtcSupport = !!(window.RTCPeerConnection && window.RTCSessionDescription);
        document.getElementById('webrtcSupport').innerHTML = webrtcSupport ? 
            '<span class="status-indicator status-green"></span> Supported' : 
            '<span class="status-indicator status-red"></span> Not Supported';

        // Check MediaDevices API support
        const mediaDevicesSupport = !!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia);
        document.getElementById('mediaDevicesSupport').innerHTML = mediaDevicesSupport ? 
            '<span class="status-indicator status-green"></span> Supported' : 
            '<span class="status-indicator status-red"></span> Not Supported';

        // Check screen sharing support
        const screenSharingSupport = !!(navigator.mediaDevices && navigator.mediaDevices.getDisplayMedia);
        document.getElementById('screenSharingSupport').innerHTML = screenSharingSupport ? 
            '<span class="status-indicator status-green"></span> Supported' : 
            '<span class="status-indicator status-red"></span> Not Supported';

        // Global variables
        let stream = null;

        // Logging function
        function log(message, type = 'info') {
            const now = new Date();
            const timestamp = now.toLocaleTimeString();
            const entry = document.createElement('div');
            entry.innerHTML = `<strong>${timestamp}</strong>: ${message}`;
            
            if (type === 'error') {
                entry.style.color = '#d32f2f';
            } else if (type === 'success') {
                entry.style.color = '#388e3c';
            } else if (type === 'warning') {
                entry.style.color = '#f57c00';
            }
            
            logElement.appendChild(entry);
            logElement.scrollTop = logElement.scrollHeight;
        }

        // Function to update device list
        function updateDeviceList() {
            if (!navigator.mediaDevices || !navigator.mediaDevices.enumerateDevices) {
                deviceList.innerHTML = '<div class="error">enumerateDevices() not supported in this browser</div>';
                return;
            }

            navigator.mediaDevices.enumerateDevices()
                .then(devices => {
                    const videoDevices = devices.filter(device => device.kind === 'videoinput');
                    const audioDevices = devices.filter(device => device.kind === 'audioinput');
                    const audioOutputDevices = devices.filter(device => device.kind === 'audiooutput');

                    let html = '<table>';
                    html += '<tr><th>Type</th><th>Device</th><th>ID</th></tr>';

                    if (videoDevices.length === 0) {
                        html += '<tr><td>Video</td><td colspan="2">No video devices found</td></tr>';
                    } else {
                        videoDevices.forEach((device, index) => {
                            html += `<tr>
                                <td>Video ${index + 1}</td>
                                <td>${device.label || 'Label not available (permission needed)'}</td>
                                <td>${device.deviceId.substring(0, 8)}...</td>
                            </tr>`;
                        });
                    }

                    if (audioDevices.length === 0) {
                        html += '<tr><td>Audio Input</td><td colspan="2">No audio input devices found</td></tr>';
                    } else {
                        audioDevices.forEach((device, index) => {
                            html += `<tr>
                                <td>Audio In ${index + 1}</td>
                                <td>${device.label || 'Label not available (permission needed)'}</td>
                                <td>${device.deviceId.substring(0, 8)}...</td>
                            </tr>`;
                        });
                    }

                    if (audioOutputDevices.length === 0) {
                        html += '<tr><td>Audio Output</td><td colspan="2">No audio output devices found</td></tr>';
                    } else {
                        audioOutputDevices.forEach((device, index) => {
                            html += `<tr>
                                <td>Audio Out ${index + 1}</td>
                                <td>${device.label || 'Label not available (permission needed)'}</td>
                                <td>${device.deviceId.substring(0, 8)}...</td>
                            </tr>`;
                        });
                    }

                    html += '</table>';
                    deviceList.innerHTML = html;
                })
                .catch(err => {
                    deviceList.innerHTML = `<div class="error">Error enumerating devices: ${err.message}</div>`;
                    log(`Error enumerating devices: ${err.message}`, 'error');
                });
        }

        // Initial device list update
        updateDeviceList();

        // Function to start media
        function startMedia(constraints) {
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                mediaStatus.innerHTML = '<div class="error">getUserMedia() not supported in this browser</div>';
                log('getUserMedia() not supported in this browser', 'error');
                return;
            }

            log(`Requesting media with constraints: ${JSON.stringify(constraints)}`);

            // First try with the requested constraints
            navigator.mediaDevices.getUserMedia(constraints)
                .then(handleSuccess)
                .catch(err => {
                    log(`Error with initial constraints: ${err.name} - ${err.message}`, 'error');
                    
                    // If both video and audio were requested, try fallback strategies
                    if (constraints.video && constraints.audio) {
                        log('Trying fallback: video only', 'warning');
                        // Try video only
                        navigator.mediaDevices.getUserMedia({ video: true })
                            .then(handleSuccess)
                            .catch(err => {
                                log(`Video-only fallback failed: ${err.name} - ${err.message}`, 'error');
                                
                                // Try audio only
                                log('Trying fallback: audio only', 'warning');
                                navigator.mediaDevices.getUserMedia({ audio: true })
                                    .then(handleSuccess)
                                    .catch(err => {
                                        log(`Audio-only fallback failed: ${err.name} - ${err.message}`, 'error');
                                        handleError(err);
                                    });
                            });
                    } else {
                        // If only one type was requested, just show the error
                        handleError(err);
                    }
                });
        }

        // Handle successful media acquisition
        function handleSuccess(mediaStream) {
            stream = mediaStream;
            video.srcObject = stream;
            
            const videoTracks = stream.getVideoTracks();
            const audioTracks = stream.getAudioTracks();
            
            let statusHtml = '<div class="success">Media access successful!</div>';
            statusHtml += '<ul>';
            
            if (videoTracks.length > 0) {
                statusHtml += `<li>Video: <span class="status-indicator status-green"></span> ${videoTracks[0].label}</li>`;
                log(`Using video device: ${videoTracks[0].label}`, 'success');
                
                // Show video constraints
                const videoConstraints = videoTracks[0].getConstraints();
                log(`Video constraints: ${JSON.stringify(videoConstraints)}`);
                
                // Show video settings
                const videoSettings = videoTracks[0].getSettings();
                log(`Video settings: ${JSON.stringify(videoSettings)}`);
            } else {
                statusHtml += '<li>Video: <span class="status-indicator status-red"></span> No video track</li>';
            }
            
            if (audioTracks.length > 0) {
                statusHtml += `<li>Audio: <span class="status-indicator status-green"></span> ${audioTracks[0].label}</li>`;
                log(`Using audio device: ${audioTracks[0].label}`, 'success');
                
                // Show audio constraints
                const audioConstraints = audioTracks[0].getConstraints();
                log(`Audio constraints: ${JSON.stringify(audioConstraints)}`);
                
                // Show audio settings
                const audioSettings = audioTracks[0].getSettings();
                log(`Audio settings: ${JSON.stringify(audioSettings)}`);
            } else {
                statusHtml += '<li>Audio: <span class="status-indicator status-red"></span> No audio track</li>';
            }
            
            statusHtml += '</ul>';
            mediaStatus.innerHTML = statusHtml;
            
            // Update device info
            let deviceInfoHtml = '<h3>Active Tracks</h3><ul>';
            stream.getTracks().forEach(track => {
                deviceInfoHtml += `<li>${track.kind}: ${track.label} (${track.enabled ? 'enabled' : 'disabled'})</li>`;
            });
            deviceInfoHtml += '</ul>';
            deviceInfo.innerHTML = deviceInfoHtml;
            
            // Update device list with labels
            updateDeviceList();
            
            // Update button states
            startBothBtn.disabled = true;
            startVideoBtn.disabled = true;
            startAudioBtn.disabled = true;
            stopMediaBtn.disabled = false;
        }

        // Handle media acquisition errors
        function handleError(error) {
            let errorMessage = '';
            let errorDetails = '';
            
            switch(error.name) {
                case 'NotAllowedError':
                case 'PermissionDeniedError':
                    errorMessage = 'Permission denied';
                    errorDetails = 'You need to allow camera and microphone access in your browser settings.';
                    break;
                case 'NotFoundError':
                case 'DevicesNotFoundError':
                    errorMessage = 'No camera or microphone found';
                    errorDetails = 'Please connect a camera or microphone to your device and try again.';
                    break;
                case 'NotReadableError':
                case 'TrackStartError':
                    errorMessage = 'Camera or microphone is in use';
                    errorDetails = 'Another application might be using your camera or microphone. Close other applications and try again.';
                    break;
                case 'OverconstrainedError':
                    errorMessage = 'Constraints cannot be satisfied';
                    errorDetails = 'Your device does not meet the required constraints.';
                    break;
                case 'TypeError':
                    errorMessage = 'Invalid constraints';
                    errorDetails = 'The constraints specified are not valid.';
                    break;
                default:
                    errorMessage = `Error: ${error.name}`;
                    errorDetails = error.message;
            }
            
            mediaStatus.innerHTML = `<div class="error">
                <strong>${errorMessage}</strong><br>
                ${errorDetails}
            </div>`;
            
            log(`Media error: ${error.name} - ${error.message}`, 'error');
        }

        // Function to stop media
        function stopMedia() {
            if (stream) {
                stream.getTracks().forEach(track => {
                    track.stop();
                    log(`Stopped ${track.kind} track: ${track.label}`);
                });
                
                video.srcObject = null;
                stream = null;
                
                mediaStatus.innerHTML = '';
                deviceInfo.innerHTML = 'Media stopped. Click any start button to see device information.';
                
                // Update button states
                startBothBtn.disabled = false;
                startVideoBtn.disabled = false;
                startAudioBtn.disabled = false;
                stopMediaBtn.disabled = true;
            }
        }

        // Test STUN server connectivity
        function testStunServer() {
            stunResult.innerHTML = '<div class="warning">Testing STUN server connectivity...</div>';
            iceLog.innerHTML = '';
            
            const servers = {
                iceServers: [
                    { urls: 'stun:stun.l.google.com:19302' },
                    { urls: 'stun:stun1.l.google.com:19302' }
                ]
            };
            
            log('Creating RTCPeerConnection to test STUN servers');
            const pc = new RTCPeerConnection(servers);
            let candidateFound = false;
            
            pc.onicecandidate = (event) => {
                if (event.candidate) {
                    candidateFound = true;
                    const candidateInfo = `${event.candidate.component} - ${event.candidate.type} - ${event.candidate.protocol} - ${event.candidate.address}:${event.candidate.port}`;
                    log(`ICE Candidate: ${candidateInfo}`);
                    iceLog.innerHTML += `<div>${candidateInfo}</div>`;
                    
                    if (event.candidate.type === 'srflx') {
                        stunResult.innerHTML = '<div class="success">STUN server working! Public IP address detected.</div>';
                    }
                }
            };
            
            pc.onicegatheringstatechange = () => {
                log(`ICE gathering state: ${pc.iceGatheringState}`);
                
                if (pc.iceGatheringState === 'complete') {
                    if (!candidateFound) {
                        stunResult.innerHTML = '<div class="error">No ICE candidates found. STUN server may be blocked.</div>';
                        log('No ICE candidates found. STUN server may be blocked.', 'error');
                    }
                    
                    // Close the connection
                    setTimeout(() => {
                        pc.close();
                        log('RTCPeerConnection closed');
                    }, 1000);
                }
            };
            
            // Create a data channel to trigger ICE candidate gathering
            pc.createDataChannel('test');
            
            pc.createOffer()
                .then(offer => pc.setLocalDescription(offer))
                .catch(err => {
                    stunResult.innerHTML = `<div class="error">Error creating offer: ${err.message}</div>`;
                    log(`Error creating offer: ${err.message}`, 'error');
                });
        }

        // Tab switching function
        function openTab(evt, tabName) {
            const tabContents = document.getElementsByClassName('tab-content');
            for (let i = 0; i < tabContents.length; i++) {
                tabContents[i].classList.remove('active');
            }
            
            const tabButtons = document.getElementsByClassName('tab-button');
            for (let i = 0; i < tabButtons.length; i++) {
                tabButtons[i].classList.remove('active');
            }
            
            document.getElementById(tabName).classList.add('active');
            evt.currentTarget.classList.add('active');
        }

        // Event listeners
        startBothBtn.addEventListener('click', () => startMedia({ video: true, audio: true }));
        startVideoBtn.addEventListener('click', () => startMedia({ video: true }));
        startAudioBtn.addEventListener('click', () => startMedia({ audio: true }));
        stopMediaBtn.addEventListener('click', stopMedia);
        testStunBtn.addEventListener('click', testStunServer);

        // Initial log
        log('Diagnostic tool loaded');
        log(`Browser: ${browserInfo}`);
        log(`WebRTC Support: ${webrtcSupport ? 'Yes' : 'No'}`);
        log(`MediaDevices API Support: ${mediaDevicesSupport ? 'Yes' : 'No'}`);
    </script>
</body>
</html>